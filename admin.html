<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#630d16">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="fashion.png">
    <title>Admin Gold - The Fashion Empire</title>
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root { --imperial: #630d16; --oro: #d4af37; --fondo: #0a0a0a; --tarjeta: #1a1a1a; --texto: #f4f4f4; --verde: #2ecc71; --rojo: #e74c3c; --plata: #c0c0c0; --alerta: #f39c12; }
        body { font-family: 'Montserrat', sans-serif; background: var(--fondo); color: var(--texto); margin: 0; padding: 15px; display: none; /* Se muestra tras el PIN */ }
        h2 { font-family: 'Playfair Display', serif; color: var(--oro); text-align: center; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px;}
        
        .alert-console { background: rgba(243, 156, 18, 0.1); border: 1px solid var(--alerta); border-radius: 8px; padding: 10px; margin-bottom: 15px; display: none; }
        .alert-item { color: var(--alerta); font-size: 0.85rem; margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }

        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card { background: var(--tarjeta); padding: 20px; border-radius: 12px; border-top: 4px solid var(--imperial); margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        
        label { color: var(--oro); font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .val { font-size: 1.2rem; font-weight: bold; display: block; }
        
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; font-size: 1rem; }
        .grid-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; transition: 0.3s; margin-bottom: 8px; }
        .btn-save { background: var(--imperial); color: white; box-shadow: 0 4px 10px rgba(128,0,32,0.3); }
        .btn-pdf { background: transparent; border: 1px solid var(--oro); color: var(--oro); }
        .btn-excel { background: #1D6F42; color: white; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #111; border-radius: 8px; overflow: hidden; }
        th { text-align: left; color: var(--oro); border-bottom: 2px solid var(--imperial); padding: 12px 10px; font-size: 0.75rem; }
        td { padding: 10px; border-bottom: 1px solid #222; font-size: 0.8rem; }
        
        .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 850px) { .main-layout { grid-template-columns: 1fr; } }

        .btn-anular { background: none; border: 1px solid var(--rojo); color: var(--rojo); padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; cursor: pointer; }
        
        /* Ocultar elementos para STAFF */
        .admin-only { display: none; }
    </style>
</head>
<body>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <button onclick="window.location.href='index.html'" style="background:#333; color:white; border:none; padding:10px 15px; border-radius:8px; cursor:pointer; font-weight:bold; font-size: 0.7rem;">
            üè† VOLVER A VENTAS
        </button>
        <span id="roleBadge" style="color: var(--oro); font-size: 0.7rem; font-weight: bold; border: 1px solid var(--oro); padding: 5px 10px; border-radius: 12px;">ROL: -</span>
    </div>

    <header style="text-align: center; margin-bottom: 15px;">
        <img src="fashion.png" alt="Logo" style="width: 100px; margin-bottom: 10px;">
        <h2>The Fashion Empire</h2>
        <p style="color: var(--plata); font-style: italic; margin: 0; font-size: 0.8rem;">Royal Inventory & Sales Control</p>
    </header>

    <div id="alertConsole" class="alert-console">
        <label style="color: var(--alerta); margin-bottom: 10px; display: block;">‚ö†Ô∏è Alertas de Suministros</label>
        <div id="alertList"></div>
    </div>

    <div class="grid-stats">
        <div class="card admin-only" id="cardCapital" style="border-top-color: var(--oro)">
            <label>Capital Invertido</label>
            <span id="capInvertido" class="val">$0</span>
        </div>
        <div class="card" style="border-top-color: var(--verde)">
            <label>Ventas Hoy</label>
            <span id="ventasDia" class="val" style="color: var(--verde)">$0</span>
        </div>
        <div class="card" style="border-top-color: var(--plata)">
            <label>Top Producto</label>
            <span id="topProducto" class="val" style="font-size: 0.85rem;">-</span>
        </div>
        <div class="card" style="border-top-color: var(--imperial)">
            <label>Items Totales</label>
            <span id="contadorItems" class="val">0</span>
        </div>
    </div>

    <div class="main-layout">
        <div>
            <div class="card">
                <label>üëë Gesti√≥n de Producto</label>
                <input type="text" id="nom" placeholder="Nombre de la Prenda">
                <div class="grid-inputs">
                    <div><label>Talle</label><input type="text" id="talle" placeholder="Talle"></div>
                    <div><label>Color</label><input type="text" id="color" placeholder="Color"></div>
                </div>
                <label>Categor√≠a</label>
                <select id="cat">
                    <option value="Sacos">Sacos / Blazers</option>
                    <option value="Pantalones">Pantalones</option>
                    <option value="Camisas">Camisas</option>
                    <option value="Calzado">Calzado</option>
                    <option value="Accesorios">Accesorios</option>
                </select>
                <div class="grid-inputs">
                    <div class="admin-only"><label>Costo ($)</label><input type="number" id="cos" placeholder="0"></div>
                    <div><label>Venta ($)</label><input type="number" id="pre" placeholder="0"></div>
                </div>
                <div class="grid-inputs">
                    <div><label>Stock</label><input type="number" id="sto" placeholder="Cant."></div>
                    <div><label>ID / C√≥digo</label><input type="text" id="cod" placeholder="C√≥digo"></div>
                </div>
                <button class="btn btn-save" onclick="guardarPrenda()">üíæ GUARDAR EN INVENTARIO</button>
                <button class="btn btn-pdf admin-only" onclick="generarPDF()">üìÑ REPORTE PDF</button>
                <button class="btn btn-excel admin-only" onclick="exportarExcel()">üìä EXPORTAR VENTAS EXCEL</button>
            </div>

            <div class="card admin-only">
                <label>üìà Desempe√±o Semanal ($)</label>
                <canvas id="graficoVentas" height="150"></canvas>
            </div>
        </div>

        <div>
            <div class="card" style="border-top-color: var(--verde)">
                <label>üõçÔ∏è Historial de Ventas</label>
                <input type="text" id="buscarVentaID" style="border: 1px solid var(--verde); background:#000;" placeholder="üîç Buscar Ticket..." onkeyup="filtrarVentas()">
                <div style="max-height: 380px; overflow-y: auto;">
                    <table id="tablaVentas">
                        <thead>
                            <tr>
                                <th>HORA/ID</th>
                                <th>DETALLE</th>
                                <th>TOTAL</th>
                                <th class="admin-only">ACCI√ìN</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoVentas"></tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="border-top-color: var(--plata)">
                <label>üì¶ Inventario Imperial</label>
                <div style="max-height: 500px; overflow-y: auto;">
                    <table id="tablaInv">
                        <thead>
                            <tr>
                                <th>DETALLE</th>
                                <th style="text-align: center;">STOCK</th>
                                <th style="text-align: right;">VENTA</th>
                                <th style="text-align: center;">ACCIONES</th>
                            </tr>
                        </thead>
                        <tbody id="cuerpoTabla"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

<script>
    const SB_URL = "https://svpurpvbiujhcbiugrkh.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2cHVycHZiaXVqaGNiaXVncmtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDgzMTUsImV4cCI6MjA4MzMyNDMxNX0.AivKJ0_N0z_4T4vLNfUcE2hepJ1XXOO8-4fSA3PJXdc";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    
    let todosLosProductos = [];
    let todasLasVentas = [];
    let graficoInstance = null;
    let currentRole = "";

    // --- SEGURIDAD ---
    async function checkAccess() {
        const { value: pin } = await Swal.fire({
            title: 'ACCESO REAL',
            input: 'password',
            inputLabel: 'Ingrese PIN de Seguridad',
            inputPlaceholder: '****',
            background: '#0a0a0a',
            color: '#fff',
            confirmButtonColor: '#630d16',
            allowOutsideClick: false
        });

        if (pin === '2026') {
            currentRole = "DUE√ëO";
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
            document.body.style.display = 'block';
        } else if (pin === '1234') {
            currentRole = "STAFF";
            document.body.style.display = 'block';
        } else {
            Swal.fire('Error', 'PIN Incorrecto', 'error').then(() => window.location.href = 'index.html');
        }
        document.getElementById('roleBadge').innerText = `ROL: ${currentRole}`;
        cargarTodo();
    }

    async function cargarTodo() {
        const { data: productos } = await _supabase.from('productos_boutique').select('*').order('created_at', { ascending: false });
        todosLosProductos = productos || [];
        renderizarTabla(todosLosProductos);
        actualizarMetricas(todosLosProductos);
        actualizarAlertas(todosLosProductos);
        cargarVentasYGrafico();
    }

    function renderizarTabla(lista) {
        const tbody = document.getElementById('cuerpoTabla');
        tbody.innerHTML = "";
        document.getElementById('contadorItems').innerText = lista.length;
        lista.forEach(item => {
            const stockBajo = item.stock <= 2;
            tbody.innerHTML += `
                <tr>
                    <td onclick="prepararEdicion('${item.codigo_barras}')" style="cursor:pointer">
                        <strong>${item.nombre}</strong><br><small style="color:var(--plata)">${item.talle} | ${item.color}</small>
                    </td>
                    <td style="text-align: center;">
                        <span style="color: ${stockBajo ? 'var(--rojo)' : 'var(--verde)'}; font-weight: bold; font-size:1.1rem;">${item.stock}</span>
                        <div style="display:flex; gap:3px; justify-content:center; margin-top:5px;">
                            <button onclick="ajustarStock('${item.codigo_barras}', ${item.stock - 1})" style="background:#333;color:white;border:none;padding:5px 8px;border-radius:4px;cursor:pointer;">-</button>
                            <button onclick="ajustarStock('${item.codigo_barras}', ${item.stock + 1})" style="background:#333;color:white;border:none;padding:5px 8px;border-radius:4px;cursor:pointer;">+</button>
                        </div>
                    </td>
                    <td style="text-align: right; font-weight: bold; color: var(--oro);">$${item.precio_venta.toLocaleString()}</td>
                    <td style="text-align: center;">
                        <button onclick="eliminarProducto('${item.codigo_barras}', '${item.nombre}')" style="background:none;border:none;color:var(--rojo);cursor:pointer;font-size:1.1rem;">üóëÔ∏è</button>
                    </td>
                </tr>`;
        });
    }

    function actualizarAlertas(productos) {
        const alertConsole = document.getElementById('alertConsole');
        const alertList = document.getElementById('alertList');
        const criticos = productos.filter(p => p.stock <= 2);
        
        if (criticos.length > 0) {
            alertConsole.style.display = 'block';
            alertList.innerHTML = criticos.map(p => `
                <div class="alert-item">
                    <span>${p.stock === 0 ? '‚ùå AGOTADO:' : '‚ö†Ô∏è BAJO STOCK:'}</span>
                    <strong>${p.nombre} (${p.talle})</strong> - Solo quedan ${p.stock} unidades.
                </div>
            `).join('');
        } else {
            alertConsole.style.display = 'none';
        }
    }

    async function cargarVentasYGrafico() {
        const { data: ventas, error } = await _supabase.from('ventas_boutique').select('*').order('created_at', { ascending: false });
        if (error) return;
        todasLasVentas = ventas || [];
        procesarVentas(todasLasVentas);
        if(currentRole === "DUE√ëO") cargarGrafico(todasLasVentas);
    }

    function procesarVentas(ventas) {
        const hoy = new Date().toISOString().split('T')[0];
        const tbody = document.getElementById('cuerpoVentas');
        let sumaHoy = 0;
        let conteoProductos = {};
        tbody.innerHTML = "";
        
        ventas.forEach(v => {
            if (v.created_at.startsWith(hoy)) sumaHoy += v.total;
            const partes = v.detalles.split(', ');
            partes.forEach(p => {
                const nombre = p.split('x ')[1] || p;
                if(nombre && !nombre.includes('FE-')) {
                    const soloNombre = nombre.split(' (')[0];
                    conteoProductos[soloNombre] = (conteoProductos[soloNombre] || 0) + 1;
                }
            });
            renderFilaVenta(v, tbody);
        });

        document.getElementById('ventasDia').innerText = `$${sumaHoy.toLocaleString()}`;
        const top = Object.entries(conteoProductos).sort((a,b) => b[1] - a[1])[0];
        document.getElementById('topProducto').innerText = top ? top[0] : "Sin datos";
    }

    function renderFilaVenta(v, container) {
        const hora = new Date(v.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        container.innerHTML += `<tr>
            <td><small>${hora}</small></td>
            <td><small>${v.detalles}</small></td>
            <td style="font-weight:bold; color:var(--verde)">$${v.total.toLocaleString()}</td>
            <td class="${currentRole === 'DUE√ëO' ? '' : 'admin-only'}"><button class="btn-anular" onclick="anularVenta('${v.id}', '${v.detalles}')">Anular</button></td>
        </tr>`;
    }

    async function anularVenta(id, detalles) {
        if (!confirm("¬øSeguro que deseas ANULAR esta venta? El stock se restaurar√°.")) return;
        const items = detalles.split(', ');
        for (const item of items) {
            if (item.includes('x ')) {
                const cant = parseInt(item.split('x ')[0]);
                const matchCodigo = item.match(/FE-\d+/); // Busca el c√≥digo generado
                if (matchCodigo) {
                    const codigo = matchCodigo[0];
                    const { data: p } = await _supabase.from('productos_boutique').select('stock').eq('codigo_barras', codigo).single();
                    if (p) await _supabase.from('productos_boutique').update({ stock: p.stock + cant }).eq('codigo_barras', codigo);
                }
            }
        }
        await _supabase.from('ventas_boutique').delete().eq('id', id);
        cargarTodo();
    }

    async function guardarPrenda() {
        const datos = {
            codigo_barras: document.getElementById('cod').value || "FE-" + Date.now(),
            nombre: document.getElementById('nom').value,
            talle: document.getElementById('talle').value,
            color: document.getElementById('color').value,
            categoria: document.getElementById('cat').value,
            precio_costo: parseFloat(document.getElementById('cos').value) || 0,
            precio_venta: parseFloat(document.getElementById('pre').value) || 0,
            stock: parseInt(document.getElementById('sto').value) || 0
        };
        const { error } = await _supabase.from('productos_boutique').upsert(datos);
        if (error) alert(error.message); else { cargarTodo(); limpiarInputs(); }
    }

    async function ajustarStock(codigo, nuevo) {
        if (nuevo < 0) return;
        await _supabase.from('productos_boutique').update({ stock: nuevo }).eq('codigo_barras', codigo);
        cargarTodo();
    }

    function exportarExcel() {
        let csv = "\uFEFFID;Detalles;Total;Metodo;Fecha\n";
        todasLasVentas.forEach(v => { csv += `${v.id};"${v.detalles}";${v.total};${v.metodo};${v.created_at}\n`; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Ventas_Fashion_Empire.csv";
        link.click();
    }

    function generarPDF() {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(18); doc.text("REPORTE DE INVENTARIO - THE FASHION EMPIRE", 105, 15, { align: "center" });
        const filas = todosLosProductos.map(p => [p.nombre, p.talle, p.color, p.stock, `$${p.precio_venta}`]);
        doc.autoTable({ head: [['Producto', 'Talle', 'Color', 'Stock', 'Precio']], body: filas, startY: 25, headStyles: { fillColor: [99, 13, 22] } });
        doc.save("Inventario_Empire.pdf");
    }

    function filtrarVentas() {
        const q = document.getElementById('buscarVentaID').value.toLowerCase();
        const tbody = document.getElementById('cuerpoVentas');
        tbody.innerHTML = "";
        todasLasVentas.filter(v => v.detalles.toLowerCase().includes(q)).forEach(v => renderFilaVenta(v, tbody));
    }

    function limpiarInputs() { ['nom','talle','color','cos','pre','sto','cod'].forEach(id => document.getElementById(id).value = ""); }
    
    function prepararEdicion(codigo) {
        const p = todosLosProductos.find(i => i.codigo_barras === codigo);
        if (p) {
            document.getElementById('nom').value = p.nombre; document.getElementById('talle').value = p.talle;
            document.getElementById('color').value = p.color; document.getElementById('cat').value = p.categoria;
            document.getElementById('cos').value = p.precio_costo; document.getElementById('pre').value = p.precio_venta;
            document.getElementById('sto').value = p.stock; document.getElementById('cod').value = p.codigo_barras;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }

    async function eliminarProducto(codigo, nombre) {
        if (confirm(`¬øEliminar "${nombre}" del sistema?`)) {
            await _supabase.from('productos_boutique').delete().eq('codigo_barras', codigo);
            cargarTodo();
        }
    }

    function actualizarMetricas(data) {
        if(currentRole === "DUE√ëO") {
            let cap = 0; data.forEach(p => cap += (p.precio_costo * p.stock));
            document.getElementById('capInvertido').innerText = `$${cap.toLocaleString()}`;
        }
    }

    async function cargarGrafico(ventas) {
        const montos = [0, 0, 0, 0, 0, 0, 0];
        const etiquetas = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        ventas.forEach(v => {
            const d = new Date(v.created_at).getDay();
            montos[d] += v.total;
        });
        const ctx = document.getElementById('graficoVentas').getContext('2d');
        if (graficoInstance) graficoInstance.destroy();
        graficoInstance = new Chart(ctx, {
            type: 'bar',
            data: { labels: etiquetas, datasets: [{ label: 'Ventas $', data: montos, backgroundColor: '#630d16', borderRadius: 5 }] },
            options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#222' } } } }
        });
    }

    window.onload = checkAccess;
</script>
</body>
</html>