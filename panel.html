<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Fashion Empire - Secure Admin</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Montserrat:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --imperial: #630d16; --oro: #d4af37; --fondo: #0a0a0a; --tarjeta: #1a1a1a; --texto: #f4f4f4; --verde: #2ecc71; --rojo: #e74c3c; --plata: #c0c0c0; }
        body { font-family: 'Montserrat', sans-serif; background: var(--fondo); color: var(--texto); margin: 0; padding: 15px; }
        
        /* Login Overlay */
        #loginOverlay { position: fixed; inset: 0; background: var(--fondo); z-index: 1000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-card { background: var(--tarjeta); padding: 40px; border-radius: 15px; border-top: 4px solid var(--oro); width: 300px; text-align: center; }
        
        .admin-only { display: none; } /* Oculto por defecto */

        /* Estilos generales */
        h2 { font-family: 'Playfair Display', serif; color: var(--oro); text-align: center; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px;}
        .alert-console { background: rgba(243, 156, 18, 0.1); border: 1px solid #f39c12; border-radius: 8px; padding: 10px; margin-bottom: 15px; display: none; }
        .grid-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 15px; }
        .card { background: var(--tarjeta); padding: 20px; border-radius: 12px; border-top: 4px solid var(--imperial); margin-bottom: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        label { color: var(--oro); font-size: 0.75rem; font-weight: bold; text-transform: uppercase; display: block; margin-bottom: 5px; }
        .val { font-size: 1.2rem; font-weight: bold; display: block; }
        input, select { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 0.8rem; margin-bottom: 8px; }
        .btn-save { background: var(--imperial); color: white; }
        .btn-pdf { background: transparent; border: 1px solid var(--oro); color: var(--oro); }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #111; }
        th { text-align: left; color: var(--oro); border-bottom: 2px solid var(--imperial); padding: 10px; font-size: 0.75rem; }
        td { padding: 10px; border-bottom: 1px solid #222; font-size: 0.8rem; }
        .main-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 850px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <img src="fashion.png" alt="Logo" style="width: 150px; margin-bottom: 20px;">
        <div class="login-card">
            <h3 style="color: var(--oro); margin-bottom: 20px;">ACCESO ROYAL</h3>
            <input type="password" id="passCode" placeholder="Ingresa PIN de acceso" style="text-align: center;">
            <button class="btn btn-save" onclick="verificarAcceso()">ENTRAR</button>
            <p id="loginError" style="color: var(--rojo); font-size: 0.8rem; margin-top: 10px; display: none;">PIN Incorrecto</p>
        </div>
    </div>

    <div id="appContent" style="display: none;">
        <header style="text-align: center; margin-bottom: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button onclick="cerrarSesion()" style="background:none; border: 1px solid var(--oro); color: var(--oro); padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.7rem;">CERRAR SESI√ìN</button>
                <span id="userRoleBadge" style="color: var(--oro); font-size: 0.7rem; font-weight: bold; border: 1px solid var(--oro); padding: 3px 8px; border-radius: 10px;">ROL: -</span>
            </div>
            <img src="fashion.png" alt="Logo" style="width: 100px; margin-bottom: 5px;">
            <h2>The Fashion Empire</h2>
        </header>

        <div id="alertConsole" class="alert-console">
            <label style="color: #f39c12;">‚ö†Ô∏è Alertas de Inventario</label>
            <div id="alertList"></div>
        </div>

        <div class="grid-stats">
            <div class="card admin-only" style="border-top-color: var(--oro)">
                <label>Capital Invertido</label>
                <span id="capInvertido" class="val">$0</span>
            </div>
            <div class="card" style="border-top-color: var(--verde)">
                <label>Ventas Hoy</label>
                <span id="ventasDia" class="val" style="color: var(--verde)">$0</span>
            </div>
            <div class="card" style="border-top-color: var(--plata)">
                <label>Top Producto</label>
                <span id="topProducto" class="val" style="font-size: 0.85rem;">-</span>
            </div>
            <div class="card" style="border-top-color: var(--imperial)">
                <label>Items Totales</label>
                <span id="contadorItems" class="val">0</span>
            </div>
        </div>

        <div class="main-layout">
            <div>
                <div class="card admin-only">
                    <label>üëë Gesti√≥n de Producto</label>
                    <input type="text" id="nom" placeholder="Nombre de la Prenda">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="text" id="talle" placeholder="Talle">
                        <input type="text" id="color" placeholder="Color">
                    </div>
                    <select id="cat">
                        <option value="Sacos">Sacos / Blazers</option>
                        <option value="Pantalones">Pantalones</option>
                        <option value="Camisas">Camisas</option>
                        <option value="Calzado">Calzado</option>
                    </select>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="cos" placeholder="Costo ($)">
                        <input type="number" id="pre" placeholder="Venta ($)">
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="sto" placeholder="Stock">
                        <input type="text" id="cod" placeholder="C√≥digo">
                    </div>
                    <button class="btn btn-save" onclick="guardarPrenda()">üíæ GUARDAR</button>
                    <button class="btn btn-pdf" onclick="generarPDF()">üìÑ PDF</button>
                    <button class="btn" style="background:#1D6F42; color:white" onclick="exportarExcel()">üìä EXCEL</button>
                </div>

                <div class="card">
                    <label>üìà Desempe√±o Semanal ($)</label>
                    <canvas id="graficoVentas" height="150"></canvas>
                </div>
            </div>

            <div>
                <div class="card" style="border-top-color: var(--verde)">
                    <label>üõçÔ∏è Historial de Ventas</label>
                    <input type="text" id="buscarVentaID" placeholder="üîç Buscar Ticket..." onkeyup="filtrarVentas()">
                    <div style="max-height: 380px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>HORA</th>
                                    <th>DETALLE</th>
                                    <th>TOTAL</th>
                                    <th class="admin-only">ACCION</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoVentas"></tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="border-top-color: var(--plata)">
                    <label>üì¶ Inventario Imperial</label>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>DETALLE</th>
                                    <th style="text-align: center;">STOCK</th>
                                    <th style="text-align: right;">VENTA</th>
                                    <th class="admin-only" style="text-align: center;">-</th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTabla"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    const SB_URL = "https://svpurpvbiujhcbiugrkh.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN2cHVycHZiaXVqaGNiaXVncmtoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3NDgzMTUsImV4cCI6MjA4MzMyNDMxNX0.AivKJ0_N0z_4T4vLNfUcE2hepJ1XXOO8-4fSA3PJXdc";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);
    
    // CONFIGURACI√ìN DE PINES
    const PINES = {
        "1234": "ADMIN",
        "5678": "VENDEDOR"
    };

    let currentUserRole = null;
    let todosLosProductos = [];
    let todasLasVentas = [];
    let graficoInstance = null;

    function verificarAcceso() {
        const pin = document.getElementById('passCode').value;
        if (PINES[pin]) {
            currentUserRole = PINES[pin];
            aplicarSeguridad();
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('appContent').style.display = 'block';
            cargarTodo();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    }

    function cerrarSesion() {
        location.reload();
    }

    function aplicarSeguridad() {
        document.getElementById('userRoleBadge').innerText = "ROL: " + currentUserRole;
        if (currentUserRole === "ADMIN") {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'block');
        } else {
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
        }
    }

    async function cargarTodo() {
        const { data: productos } = await _supabase.from('productos_boutique').select('*').order('created_at', { ascending: false });
        todosLosProductos = productos || [];
        renderizarTabla(todosLosProductos);
        actualizarAlertas(todosLosProductos);
        if (currentUserRole === "ADMIN") actualizarMetricas(todosLosProductos);
        cargarVentasYGrafico();
    }

    function renderizarTabla(lista) {
        const tbody = document.getElementById('cuerpoTabla');
        tbody.innerHTML = "";
        document.getElementById('contadorItems').innerText = lista.length;
        lista.forEach(item => {
            const stockBajo = item.stock <= 2;
            const botonesAdmin = currentUserRole === "ADMIN" ? `
                <td style="text-align: center;">
                    <button onclick="eliminarProducto('${item.codigo_barras}', '${item.nombre}')" style="background:none;border:none;color:var(--rojo);cursor:pointer;">üóëÔ∏è</button>
                </td>` : '';
            
            const controlStock = currentUserRole === "ADMIN" ? `
                <div style="display:flex; gap:3px; justify-content:center; margin-top:5px;">
                    <button onclick="ajustarStock('${item.codigo_barras}', ${item.stock - 1})" style="background:#333;color:white;border:none;padding:5px 8px;border-radius:4px;cursor:pointer;">-</button>
                    <button onclick="ajustarStock('${item.codigo_barras}', ${item.stock + 1})" style="background:#333;color:white;border:none;padding:5px 8px;border-radius:4px;cursor:pointer;">+</button>
                </div>` : '';

            tbody.innerHTML += `
                <tr>
                    <td onclick="${currentUserRole === 'ADMIN' ? `prepararEdicion('${item.codigo_barras}')` : ''}" style="cursor:${currentUserRole === 'ADMIN' ? 'pointer' : 'default'}">
                        <strong>${item.nombre}</strong><br><small>${item.talle} | ${item.color}</small>
                    </td>
                    <td style="text-align: center;">
                        <span style="color: ${stockBajo ? 'var(--rojo)' : 'var(--verde)'}; font-weight: bold;">${item.stock}</span>
                        ${controlStock}
                    </td>
                    <td style="text-align: right; font-weight: bold; color: var(--oro);">$${item.precio_venta.toLocaleString()}</td>
                    ${botonesAdmin}
                </tr>`;
        });
    }

    // El resto de funciones (guardar, anular, alertas, grafico) se mantienen igual 
    // pero con las protecciones de rol aplicadas en los renders.

    async function cargarVentasYGrafico() {
        const { data: ventas } = await _supabase.from('ventas_boutique').select('*').order('created_at', { ascending: false });
        todasLasVentas = ventas || [];
        procesarVentas(todasLasVentas);
        cargarGrafico(todasLasVentas);
    }

    function procesarVentas(ventas) {
        const hoy = new Date().toISOString().split('T')[0];
        const tbody = document.getElementById('cuerpoVentas');
        let sumaHoy = 0;
        tbody.innerHTML = "";
        
        ventas.forEach(v => {
            if (v.created_at.startsWith(hoy)) sumaHoy += v.total;
            const hora = new Date(v.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const accionAdmin = currentUserRole === "ADMIN" ? `<td><button class="btn-anular" style="border:1px solid var(--rojo); color:var(--rojo); background:none; cursor:pointer; font-size:0.6rem; border-radius:3px;" onclick="anularVenta('${v.id}', '${v.detalles}')">ANULAR</button></td>` : '<td>-</td>';

            tbody.innerHTML += `<tr>
                <td><small>${hora}</small></td>
                <td><small>${v.detalles}</small></td>
                <td style="font-weight:bold; color:var(--verde)">$${v.total.toLocaleString()}</td>
                ${accionAdmin}
            </tr>`;
        });
        document.getElementById('ventasDia').innerText = `$${sumaHoy.toLocaleString()}`;
    }

    async function anularVenta(id, detalles) {
        if (currentUserRole !== "ADMIN") return;
        if (!confirm("¬øAnular venta y restaurar stock?")) return;
        const items = detalles.split(', ');
        for (const item of items) {
            if (item.includes('x ')) {
                const cant = parseInt(item.split('x ')[0]);
                const codigo = item.substring(item.lastIndexOf('(') + 1, item.lastIndexOf(')'));
                const { data: p } = await _supabase.from('productos_boutique').select('stock').eq('codigo_barras', codigo).single();
                if (p) await _supabase.from('productos_boutique').update({ stock: p.stock + cant }).eq('codigo_barras', codigo);
            }
        }
        await _supabase.from('ventas_boutique').delete().eq('id', id);
        cargarTodo();
    }

    // Funciones auxiliares cortas
    async function guardarPrenda() { 
        if(currentUserRole !== "ADMIN") return;
        const datos = { codigo_barras: document.getElementById('cod').value || "FE-"+Date.now(), nombre: document.getElementById('nom').value, talle: document.getElementById('talle').value, color: document.getElementById('color').value, categoria: document.getElementById('cat').value, precio_costo: parseFloat(document.getElementById('cos').value) || 0, precio_venta: parseFloat(document.getElementById('pre').value) || 0, stock: parseInt(document.getElementById('sto').value) || 0 };
        await _supabase.from('productos_boutique').upsert(datos); cargarTodo(); limpiarInputs();
    }
    async function ajustarStock(codigo, nuevo) { if(currentUserRole !== "ADMIN" || nuevo < 0) return; await _supabase.from('productos_boutique').update({ stock: nuevo }).eq('codigo_barras', codigo); cargarTodo(); }
    async function eliminarProducto(codigo, nombre) { if(currentUserRole === "ADMIN" && confirm(`Eliminar ${nombre}?`)) { await _supabase.from('productos_boutique').delete().eq('codigo_barras', codigo); cargarTodo(); } }
    function limpiarInputs() { ['nom','talle','color','cos','pre','sto','cod'].forEach(id => document.getElementById(id).value = ""); }
    function actualizarMetricas(data) { let cap = 0; data.forEach(p => cap += (p.precio_costo * p.stock)); document.getElementById('capInvertido').innerText = `$${cap.toLocaleString()}`; }
    function exportarExcel() { if(currentUserRole !== "ADMIN") return; let csv = "\uFEFFID;Detalles;Total;Fecha\n"; todasLasVentas.forEach(v => csv += `${v.id};"${v.detalles}";${v.total};${v.created_at}\n`); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); link.download = "Ventas.csv"; link.click(); }
    function generarPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); doc.text("INVENTARIO EMPIRE", 10, 10); doc.autoTable({ head: [['Producto', 'Stock', 'Precio']], body: todosLosProductos.map(p => [p.nombre, p.stock, p.precio_venta]) }); doc.save("Inventario.pdf"); }
    function actualizarAlertas(productos) { const list = document.getElementById('alertList'); const criticos = productos.filter(p => p.stock <= 2); document.getElementById('alertConsole').style.display = criticos.length ? 'block' : 'none'; list.innerHTML = criticos.map(p => `<div style="color:#f39c12; font-size:0.75rem;">‚ö†Ô∏è ${p.nombre} (${p.talle}) - Quedan: ${p.stock}</div>`).join(''); }
    function cargarGrafico(ventas) { const montos = [0,0,0,0,0,0,0]; ventas.forEach(v => montos[new Date(v.created_at).getDay()] += v.total); if(graficoInstance) graficoInstance.destroy(); graficoInstance = new Chart(document.getElementById('graficoVentas'), { type: 'bar', data: { labels: ['D','L','M','X','J','V','S'], datasets: [{label:'$', data: montos, backgroundColor: '#630d16'}] }, options: {plugins:{legend:{display:false}}}}); }
</script>
</body>
</html>